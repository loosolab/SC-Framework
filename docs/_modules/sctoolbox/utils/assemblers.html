<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sctoolbox.utils.assemblers &mdash; SC FRAMEWORK  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            SC FRAMEWORK
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../CHANGES.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rna-notebooks/index.html">RNA notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../atac-notebooks/index.html">ATAC notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../general-notebooks/index.html">General notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/index.html">sctoolbox API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">SC FRAMEWORK</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">sctoolbox.utils.assemblers</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sctoolbox.utils.assemblers</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module to assemble anndata objects.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">sparse</span>
<span class="kn">from</span> <span class="nn">scipy.io</span> <span class="kn">import</span> <span class="n">mmread</span>

<span class="kn">from</span> <span class="nn">beartype.typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">beartype</span> <span class="kn">import</span> <span class="n">beartype</span>

<span class="kn">import</span> <span class="nn">sctoolbox.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">from</span> <span class="nn">sctoolbox._settings</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">logger</span>


<span class="c1">#####################################################################</span>
<span class="c1">#                   Assemble from multiple h5ad files               #</span>
<span class="c1">#####################################################################</span>

<div class="viewcode-block" id="prepare_atac_anndata">
<a class="viewcode-back" href="../../../API/utils.html#sctoolbox.utils.assemblers.prepare_atac_anndata">[docs]</a>
<span class="nd">@beartype</span>
<span class="k">def</span> <span class="nf">prepare_atac_anndata</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span>
                         <span class="n">set_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">index_from</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">coordinate_cols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">h5ad_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare AnnData object of ATAC-seq data to be in the correct format for the subsequent pipeline.</span>

<span class="sd">    This includes formatting the index, formatting the coordinate columns, and setting the barcode as the index.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : sc.AnnData</span>
<span class="sd">        The AnnData object to be prepared.</span>
<span class="sd">    set_index : bool, default True</span>
<span class="sd">        If True, index will be formatted and can be set by a given column.</span>
<span class="sd">    index_from : Optional[str], default None</span>
<span class="sd">        Column to build the index from.</span>
<span class="sd">    coordinate_cols : Optional[list[str]], default None</span>
<span class="sd">        Location information of the peaks.</span>
<span class="sd">    h5ad_path : Optional[str], default None</span>
<span class="sd">        Path to the h5ad file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sc.AnnData</span>
<span class="sd">        The prepared AnnData object.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">set_index</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;formatting index&quot;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">var_index_from</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">index_from</span><span class="p">)</span>

    <span class="c1"># Establish columns for coordinates</span>
    <span class="k">if</span> <span class="n">coordinate_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coordinate_cols</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># first three columns are coordinates</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">check_columns</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">,</span>
                            <span class="n">coordinate_cols</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;adata.var&quot;</span><span class="p">)</span>  <span class="c1"># Check that coordinate_cols are in adata.var)</span>

    <span class="c1"># Format coordinate columns</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;formatting coordinate columns&quot;</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">format_adata_var</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">coordinate_cols</span><span class="p">,</span> <span class="n">coordinate_cols</span><span class="p">)</span>

    <span class="c1"># check if the barcode is the index otherwise set it</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">barcode_index</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">h5ad_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">h5ad_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">adata</span></div>



<span class="c1">#####################################################################</span>
<span class="c1">#          ASSEMBLING ANNDATA FROM STARSOLO OUTPUT FOLDERS          #</span>
<span class="c1">#####################################################################</span>

<div class="viewcode-block" id="from_single_starsolo">
<a class="viewcode-back" href="../../../API/utils.html#sctoolbox.utils.assemblers.from_single_starsolo">[docs]</a>
<span class="nd">@beartype</span>
<span class="k">def</span> <span class="nf">from_single_starsolo</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">dtype</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;filtered&#39;</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;filtered&quot;</span><span class="p">,</span>
                         <span class="n">header</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;infer&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;infer&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assembles an anndata object from the starsolo folder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to the &quot;solo&quot; folder from starsolo.</span>
<span class="sd">    dtype : Literal[&#39;filtered&#39;, &#39;raw&#39;], default &quot;filtered&quot;</span>
<span class="sd">        The type of solo data to choose.</span>
<span class="sd">    header : Union[int, list[int], Literal[&#39;infer&#39;], None], default &quot;infer&quot;</span>
<span class="sd">        Set header parameter for reading metadata tables using pandas.read_csv.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sc.AnnData</span>
<span class="sd">        An anndata object based on the provided starsolo folder.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        If path does not exist or files are missing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Establish which directory to look for data in</span>
    <span class="n">genedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Gene&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">velodir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Velocyto&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">[</span><span class="n">genedir</span><span class="p">,</span> <span class="n">velodir</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The path to the data does not exist: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># File paths for different elements</span>
    <span class="n">matrix_f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">genedir</span><span class="p">,</span> <span class="s1">&#39;matrix.mtx&#39;</span><span class="p">)</span>
    <span class="n">barcodes_f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">genedir</span><span class="p">,</span> <span class="s2">&quot;barcodes.tsv&quot;</span><span class="p">)</span>
    <span class="n">genes_f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">genedir</span><span class="p">,</span> <span class="s2">&quot;genes.tsv&quot;</span><span class="p">)</span>
    <span class="n">spliced_f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">velodir</span><span class="p">,</span> <span class="s1">&#39;spliced.mtx&#39;</span><span class="p">)</span>
    <span class="n">unspliced_f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">velodir</span><span class="p">,</span> <span class="s1">&#39;unspliced.mtx&#39;</span><span class="p">)</span>
    <span class="n">ambiguous_f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">velodir</span><span class="p">,</span> <span class="s1">&#39;ambiguous.mtx&#39;</span><span class="p">)</span>

    <span class="c1"># Check whether files are present</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">matrix_f</span><span class="p">,</span> <span class="n">barcodes_f</span><span class="p">,</span> <span class="n">genes_f</span><span class="p">,</span> <span class="n">spliced_f</span><span class="p">,</span> <span class="n">unspliced_f</span><span class="p">,</span> <span class="n">ambiguous_f</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File &#39;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&#39; was not found. Please check that path contains the full output of starsolo.&quot;</span><span class="p">)</span>

    <span class="c1"># Setup main adata object from matrix/barcodes/genes</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting up adata from solo files&quot;</span><span class="p">)</span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">from_single_mtx</span><span class="p">(</span><span class="n">matrix_f</span><span class="p">,</span> <span class="n">barcodes_f</span><span class="p">,</span> <span class="n">genes_f</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">]</span>  <span class="c1"># specific to the starsolo format</span>

    <span class="c1"># Add in velocity information</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding velocity information from spliced/unspliced/ambiguous&quot;</span><span class="p">)</span>
    <span class="n">spliced</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">mmread</span><span class="p">(</span><span class="n">spliced_f</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
    <span class="n">unspliced</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">mmread</span><span class="p">(</span><span class="n">unspliced_f</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
    <span class="n">ambiguous</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">mmread</span><span class="p">(</span><span class="n">ambiguous_f</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>

    <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;spliced&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spliced</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;unspliced&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unspliced</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;ambiguous&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ambiguous</span>

    <span class="k">return</span> <span class="n">adata</span></div>



<div class="viewcode-block" id="from_quant">
<a class="viewcode-back" href="../../../API/utils.html#sctoolbox.utils.assemblers.from_quant">[docs]</a>
<span class="nd">@beartype</span>
<span class="k">def</span> <span class="nf">from_quant</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
               <span class="n">configuration</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
               <span class="n">use_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">dtype</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="s2">&quot;filtered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;filtered&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assemble an adata object from data in the &#39;quant&#39; folder of the snakemake pipeline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        The directory where the quant folder from snakemake preprocessing is located.</span>
<span class="sd">    configuration : list</span>
<span class="sd">        Configurations to setup the samples for anndata assembling.</span>
<span class="sd">        It must containg the sample, the word used in snakemake to assign the condition,</span>
<span class="sd">        and the condition, e.g., sample1:condition:room_air</span>
<span class="sd">    use_samples : Optional[list], default None</span>
<span class="sd">        List of samples to use. If None, all samples will be used.</span>
<span class="sd">    dtype : Literal[&quot;raw&quot;, &quot;filtered&quot;], default &#39;filtered&#39;</span>
<span class="sd">        The type of Solo data to choose.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sc.AnnData</span>
<span class="sd">        The assembled anndata object.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If `use_samples` contains not existing names.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: test that quant folder is existing</span>

    <span class="c1"># Collect configuration into a dictionary</span>
    <span class="n">config_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">configuration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">configuration</span><span class="p">:</span>
            <span class="n">sample</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">condition_name</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sample</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
                <span class="n">config_dict</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">config_dict</span><span class="p">[</span><span class="n">sample</span><span class="p">][</span><span class="n">condition</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition_name</span>

    <span class="c1"># Establishing which samples to use for assembly</span>
    <span class="n">sample_dirs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">))</span>
    <span class="n">sample_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sample_dirs</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found samples: </span><span class="si">{</span><span class="n">sample_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Subset to use_samples if they are provided</span>
    <span class="k">if</span> <span class="n">use_samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_names</span><span class="p">)</span> <span class="k">if</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">use_samples</span><span class="p">]</span>
        <span class="n">sample_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
        <span class="n">sample_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using samples: </span><span class="si">{</span><span class="n">sample_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;None of the given &#39;use_samples&#39; match the samples found in the directory.&quot;</span><span class="p">)</span>

    <span class="c1"># Assembling from different samples:</span>
    <span class="n">adata_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sample_name</span><span class="p">,</span> <span class="n">sample_dir</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sample_names</span><span class="p">,</span> <span class="n">sample_dirs</span><span class="p">):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assembling sample &#39;</span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">solo_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sample_dir</span><span class="p">,</span> <span class="s2">&quot;solo&quot;</span><span class="p">)</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">from_single_starsolo</span><span class="p">(</span><span class="n">solo_dir</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># Make barcode index unique</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">sample_name</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_name</span>

        <span class="c1"># Add additional information from configuration</span>
        <span class="k">if</span> <span class="n">sample_name</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">[</span><span class="n">sample_name</span><span class="p">]:</span>
                <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="n">sample_name</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>

        <span class="n">adata_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>

    <span class="c1"># Concatenating the adata objects</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Concatenating anndata objects&quot;</span><span class="p">)</span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">adata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">adata_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">join</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span>

    <span class="c1"># Add information to uns</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">add_uns_info</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;sctoolbox&quot;</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">adata</span></div>



<span class="c1">#####################################################################</span>
<span class="c1">#          CONVERTING FROM MTX+TSV/CSV TO ANNDATA OBJECT            #</span>
<span class="c1">#####################################################################</span>

<div class="viewcode-block" id="from_single_mtx">
<a class="viewcode-back" href="../../../API/utils.html#sctoolbox.utils.assemblers.from_single_mtx">[docs]</a>
<span class="nd">@beartype</span>
<span class="k">def</span> <span class="nf">from_single_mtx</span><span class="p">(</span><span class="n">mtx</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">barcodes</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">genes</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">transpose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">header</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;infer&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;infer&#39;</span><span class="p">,</span>
                    <span class="n">barcode_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">genes_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build an adata object from single mtx and two tsv/csv files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mtx : str</span>
<span class="sd">        Path to the mtx file (.mtx)</span>
<span class="sd">    barcodes : str</span>
<span class="sd">        Path to cell label file (.obs)</span>
<span class="sd">    genes : str</span>
<span class="sd">        Path to gene label file (.var)</span>
<span class="sd">    transpose : bool, default True</span>
<span class="sd">        Set True to transpose mtx matrix.</span>
<span class="sd">    header : Union[int, list[int], Literal[&#39;infer&#39;], None], default &#39;infer&#39;</span>
<span class="sd">        Set header parameter for reading metadata tables using pandas.read_csv.</span>
<span class="sd">    barcode_index : int, default 0</span>
<span class="sd">        Column which contains the cell barcodes.</span>
<span class="sd">    genes_index : int, default 0</span>
<span class="sd">        Column which contains the gene IDs.</span>
<span class="sd">    delimiter : str, default &#39;\t&#39;</span>
<span class="sd">        delimiter of genes and barcodes table.</span>
<span class="sd">    **kwargs : Any</span>
<span class="sd">        Contains additional arguments for scanpy.read_mtx method</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sc.AnnData</span>
<span class="sd">        Anndata object containing the mtx matrix, gene and cell labels</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If barcode or gene files contain duplicates.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Read mtx file</span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_mtx</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">mtx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Transpose matrix if necessary</span>
    <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="c1"># Read in gene and cell annotation</span>
    <span class="n">barcode_csv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">barcodes</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="n">barcode_index</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">)</span>
    <span class="n">barcode_csv</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span>
    <span class="n">barcode_csv</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">barcode_csv</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>  <span class="c1"># convert to string</span>
    <span class="n">genes_csv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">genes</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="n">genes_index</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">)</span>
    <span class="n">genes_csv</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span>
    <span class="n">genes_csv</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">genes_csv</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>  <span class="c1"># convert to string</span>

    <span class="c1"># Test if they are unique</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">barcode_csv</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Barcode index column does not contain unique values&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">genes_csv</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Genes index column does not contain unique values&quot;</span><span class="p">)</span>

    <span class="c1"># Add tables to anndata object</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">barcode_csv</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">genes_csv</span>

    <span class="c1"># Add filename to .obs</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mtx</span><span class="p">)</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">adata</span></div>



<div class="viewcode-block" id="from_mtx">
<a class="viewcode-back" href="../../../API/utils.html#sctoolbox.utils.assemblers.from_mtx">[docs]</a>
<span class="nd">@beartype</span>
<span class="k">def</span> <span class="nf">from_mtx</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
             <span class="n">mtx</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;*_matrix.mtx*&quot;</span><span class="p">,</span>
             <span class="n">barcodes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;*_barcodes.tsv*&quot;</span><span class="p">,</span>
             <span class="n">genes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;*_genes.tsv*&quot;</span><span class="p">,</span>
             <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build an adata object from list of mtx, barcodes and genes files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to data files</span>
<span class="sd">    mtx : str, default &#39;*_matrix.mtx*&#39;</span>
<span class="sd">        String for glob to find matrix files.</span>
<span class="sd">    barcodes : str, default &#39;*_barcodes.tsv*&#39;</span>
<span class="sd">        String for glob to find barcode files.</span>
<span class="sd">    genes : str, default &#39;*_genes.tsv*&#39;</span>
<span class="sd">        String for glob to find gene label files.</span>
<span class="sd">    **kwargs : Any</span>
<span class="sd">        Contains additional arguments for scanpy.read_mtx method</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sc.AnnData</span>
<span class="sd">        Merged anndata object containing the mtx matrix, gene and cell labels</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If files are not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mtx</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mtx</span><span class="p">))</span>
    <span class="n">barcodes</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">barcodes</span><span class="p">))</span>
    <span class="n">genes</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">genes</span><span class="p">))</span>

    <span class="c1"># Check if lists are same length</span>
    <span class="c1"># https://stackoverflow.com/questions/35791051/better-way-to-check-if-all-lists-in-a-list-are-the-same-length</span>
    <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">([</span><span class="n">mtx</span><span class="p">,</span> <span class="n">barcodes</span><span class="p">,</span> <span class="n">genes</span><span class="p">])</span>
    <span class="n">the_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_len</span><span class="p">)</span> <span class="o">==</span> <span class="n">the_len</span> <span class="k">for</span> <span class="n">list_len</span> <span class="ow">in</span> <span class="n">it</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found different quantitys of mtx, genes, barcode files.</span><span class="se">\n</span><span class="s2"> Please check given suffixes or filenames&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">mtx</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No files were found with the given directory and suffixes&#39;</span><span class="p">)</span>

    <span class="n">adata_objects</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mtx</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading files: </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mtx</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="n">adata_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">from_single_mtx</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">barcodes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">genes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">adata_objects</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">adata_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="o">*</span><span class="n">adata_objects</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">join</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">adata_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">adata</span></div>



<div class="viewcode-block" id="convertToAdata">
<a class="viewcode-back" href="../../../API/utils.html#sctoolbox.utils.assemblers.convertToAdata">[docs]</a>
<span class="nd">@beartype</span>
<span class="k">def</span> <span class="nf">convertToAdata</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">r_home</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert .rds files containing Seurat or SingleCellExperiment to scanpy anndata.</span>

<span class="sd">    In order to work an R installation with Seurat &amp; SingleCellExperiment is required.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : str</span>
<span class="sd">        Path to the .rds or .robj file.</span>
<span class="sd">    output : Optional[str], default None</span>
<span class="sd">        Path to output .h5ad file. Won&#39;t save if None.</span>
<span class="sd">    r_home : Optional[str], default None</span>
<span class="sd">        Path to the R home directory. If None will construct path based on location of python executable.</span>
<span class="sd">        E.g for &quot;.conda/scanpy/bin/python&quot; will look at &quot;.conda/scanpy/lib/R&quot;</span>
<span class="sd">    layer : Optional[str], default None</span>
<span class="sd">        Provide name of layer to be stored in anndata. By default the main layer is stored.</span>
<span class="sd">        In case of multiome data multiple layers are present e.g. RNA and ATAC. But anndata can only store a single layer.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Optional[sc.AnnData]</span>
<span class="sd">        Returns converted anndata object if output is None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setup R</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">setup_R</span><span class="p">(</span><span class="n">r_home</span><span class="p">)</span>

    <span class="c1"># Initialize R &lt;-&gt; python interface</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">check_module</span><span class="p">(</span><span class="s2">&quot;anndata2ri&quot;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">anndata2ri</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">check_module</span><span class="p">(</span><span class="s2">&quot;rpy2&quot;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">rpy2.robjects</span> <span class="kn">import</span> <span class="n">r</span><span class="p">,</span> <span class="n">default_converter</span><span class="p">,</span> <span class="n">conversion</span><span class="p">,</span> <span class="n">globalenv</span>
    <span class="n">anndata2ri</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

    <span class="c1"># create rpy2 None to NULL converter</span>
    <span class="c1"># https://stackoverflow.com/questions/65783033/how-to-convert-none-to-r-null</span>
    <span class="n">none_converter</span> <span class="o">=</span> <span class="n">conversion</span><span class="o">.</span><span class="n">Converter</span><span class="p">(</span><span class="s2">&quot;None converter&quot;</span><span class="p">)</span>
    <span class="n">none_converter</span><span class="o">.</span><span class="n">py2rpy</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">utils</span><span class="o">.</span><span class="n">_none2null</span><span class="p">)</span>

    <span class="c1"># check if Seurat and SingleCellExperiment are installed</span>
    <span class="n">r</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        if (!suppressPackageStartupMessages(require(Seurat))) {</span>
<span class="s2">            stop(&quot;R dependency Seurat not found.&quot;)</span>
<span class="s2">        }</span>
<span class="s2">        if (!suppressPackageStartupMessages(require(SingleCellExperiment))) {</span>
<span class="s2">            stop(&quot;R dependecy SingleCellExperiment not found.&quot;)</span>
<span class="s2">        }</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># add variables into R</span>
    <span class="k">with</span> <span class="n">conversion</span><span class="o">.</span><span class="n">localconverter</span><span class="p">(</span><span class="n">default_converter</span> <span class="o">+</span> <span class="n">none_converter</span><span class="p">):</span>
        <span class="n">globalenv</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file</span>
        <span class="n">globalenv</span><span class="p">[</span><span class="s2">&quot;layer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer</span>

    <span class="c1"># ----- convert to anndata ----- #</span>
    <span class="n">r</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        # ----- load object ----- #</span>
<span class="s2">        # try loading .robj</span>
<span class="s2">        object &lt;- try({</span>
<span class="s2">            # load file; returns vector of created variables</span>
<span class="s2">            new_vars &lt;- load(file)</span>
<span class="s2">            # store new variable into another variable to work on</span>
<span class="s2">            get(new_vars[1])</span>
<span class="s2">        }, silent = TRUE)</span>

<span class="s2">        # if .robj failed try .rds</span>
<span class="s2">        if (class(object) == &quot;try-error&quot;) {</span>
<span class="s2">            # load object</span>
<span class="s2">            object &lt;- try(readRDS(file), silent = TRUE)</span>
<span class="s2">        }</span>

<span class="s2">        # if both .robj and .rds failed throw error</span>
<span class="s2">        if (class(object) == &quot;try-error&quot;) {</span>
<span class="s2">            stop(&quot;Unknown file. Expected &#39;.robj&#39; or &#39;.rds&#39; got&quot;, file)</span>
<span class="s2">        }</span>

<span class="s2">        # ----- convert to SingleCellExperiment ----- #</span>
<span class="s2">        # can only convert Seurat -&gt; SingleCellExperiment -&gt; anndata</span>
<span class="s2">        if (class(object) == &quot;Seurat&quot;) {</span>
<span class="s2">            object &lt;- as.SingleCellExperiment(object)</span>
<span class="s2">        } else if (class(object) == &quot;SingleCellExperiment&quot;) {</span>
<span class="s2">            object &lt;- object</span>
<span class="s2">        } else {</span>
<span class="s2">            stop(&quot;Unknown object! Expected class &#39;Seurat&#39; or &#39;SingleCellExperiment&#39; got &quot;, class(object))</span>
<span class="s2">        }</span>

<span class="s2">        # ----- change layer ----- #</span>
<span class="s2">        # adata can only store a single layer</span>
<span class="s2">        if (!is.null(layer)) {</span>
<span class="s2">            layers &lt;- c(mainExpName(object), altExpNames(object))</span>

<span class="s2">            # check if layer is valid</span>
<span class="s2">            if (!layer </span><span class="si">%i</span><span class="s2">n</span><span class="si">% la</span><span class="s2">yers) {</span>
<span class="s2">                stop(&quot;Invalid layer! Expected one of &quot;, paste(layers, collapse = &quot;, &quot;), &quot; got &quot;, layer)</span>
<span class="s2">            }</span>

<span class="s2">            # select layer</span>
<span class="s2">            if (layer != mainExpName(object)) {</span>
<span class="s2">                object &lt;- swapAltExp(object, layer, saved = mainExpName(object), withColData = TRUE)</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># pull SingleCellExperiment into python</span>
    <span class="c1"># this also converts to anndata</span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">globalenv</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="c1"># fixes https://gitlab.gwdg.de/loosolab/software/sc_framework/-/issues/205</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>

    <span class="c1"># Add information to uns</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">add_uns_info</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;sctoolbox&quot;</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
        <span class="c1"># Saving adata.h5ad</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">output</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">adata</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Loosolab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>